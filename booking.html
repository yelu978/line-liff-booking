<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é ç´„ä¸Šèª²1</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
    
    /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
    .step-indicator { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; }
    .step {
      width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: bold; color: #999;
    }
    .step.active { background: #667eea; color: white; }
    
    /* å€å¡Šé¡¯ç¤ºæ§åˆ¶ */
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
    .btn {
      padding: 15px 20px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; font-size: 16px; cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      width: 100%; margin-bottom: 10px;
      /* ç¦æ­¢æ–‡å­—é¸å–ï¼Œå„ªåŒ–æ‰‹æ©Ÿé«”é©— */
      user-select: none; -webkit-user-select: none;
    }
    .btn:active { transform: scale(0.98); }
    .back-btn { background: #6c757d; margin-top: 15px; }

    /* æ—¥æ›†æ¨£å¼ */
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-nav { background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 8px; font-size: 18px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day-header { text-align: center; padding: 10px; font-weight: bold; color: #666; font-size: 14px; }
    .calendar-day {
      aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
      border-radius: 8px; cursor: pointer; font-size: 14px;
    }
    .calendar-day:not(.disabled) { background: #f8f9fa; }
    .calendar-day:not(.disabled):active { background: #e2e8f0; }
    .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
    .calendar-day.selected { background: #667eea; color: white; }

    /* æ™‚æ®µæŒ‰éˆ• */
    .time-slots { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
    .time-slot {
      padding: 12px; background: white; border: 2px solid #667eea;
      border-radius: 8px; color: #667eea; cursor: pointer;
      text-align: center; font-size: 16px;
      /* é—œéµï¼šè§£æ±ºæ‰‹æ©Ÿè§¸æ§å•é¡Œ */
      touch-action: manipulation; 
    }
    .time-slot:active { background: #667eea; color: white; }
    
    /* éŒ¯èª¤è¨Šæ¯ */
    .error-message {
      background: #fff5f5; color: #c53030; padding: 20px;
      border-radius: 8px; text-align: center; border: 2px solid #feb2b2;
    }
    .retry-btn { background: #718096; margin-top: 15px; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: #667eea; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š é ç´„ä¸Šèª²</h1>
    <p class="subtitle">è«‹é¸æ“‡é†«å¸«å’Œèª²ç¨‹é€²è¡Œé ç´„</p>
    
    <div class="step-indicator">
      <div class="step active" id="step1">1</div>
      <div class="step" id="step2">2</div>
      <div class="step" id="step3">3</div>
      <div class="step" id="step4">4</div>
    </div>
    
    <div class="section active" id="section-doctor">
      <h2>é¸æ“‡é†«å¸«</h2>
      <div class="btn-grid" id="doctorList">
        <div style="grid-column: 1/-1; text-align: center;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    
    <div class="section" id="section-course">
      <h2>é¸æ“‡èª²ç¨‹</h2>
      <div id="courseList"></div>
      <button class="btn back-btn" onclick="goToStep(1)">â† è¿”å›</button>
    </div>
    
    <div class="section" id="section-date">
      <h2>é¸æ“‡æ—¥æœŸ</h2>
      <div class="calendar-header">
        <button class="calendar-nav" onclick="changeMonth(-1)">â—€</button>
        <span id="currentMonth" style="font-weight: bold; font-size: 18px;"></span>
        <button class="calendar-nav" onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="calendar-grid">
        <div class="calendar-day-header">æ—¥</div>
        <div class="calendar-day-header">ä¸€</div>
        <div class="calendar-day-header">äºŒ</div>
        <div class="calendar-day-header">ä¸‰</div>
        <div class="calendar-day-header">å››</div>
        <div class="calendar-day-header">äº”</div>
        <div class="calendar-day-header">å…­</div>
      </div>
      <div class="calendar-grid" id="calendarDays"></div>
      <button class="btn back-btn" onclick="goToStep(2)">â† è¿”å›</button>
    </div>
    
    <div class="section" id="section-time">
      <h2>é¸æ“‡æ™‚æ®µ</h2>
      <p style="color: #666; margin-bottom: 10px;">å·²é¸æ—¥æœŸ: <span id="selectedDateDisplay"></span></p>
      <div class="time-slots" id="timeSlots"></div>
      <button class="btn back-btn" onclick="goToStep(3)">â† è¿”å›</button>
    </div>
    
    <div class="section" id="section-loading">
      <div class="loading">
        <div style="font-size: 40px; margin-bottom: 15px;">â³</div>
        <div>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
      </div>
    </div>
    
    <div class="section" id="section-success">
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 60px; margin-bottom: 20px;">âœ…</div>
        <h3 style="color: #28a745; margin-bottom: 10px;">é ç´„æˆåŠŸ!</h3>
        <div id="successDetail" style="color: #666; white-space: pre-line; line-height: 1.6;"></div>
        <p style="color: #999; font-size: 12px; margin-top: 20px;">è¦–çª—å°‡åœ¨ 3 ç§’å¾Œè‡ªå‹•é—œé–‰</p>
        <button class="btn" onclick="window.close()">ç«‹å³é—œé–‰</button>
      </div>
    </div>

    <div class="section" id="section-error">
      <div class="error-message">
        <div style="font-size: 40px; margin-bottom: 10px;">âŒ</div>
        <h3>é ç´„å¤±æ•—</h3>
        <p id="errorDetail" style="margin-top: 10px; white-space: pre-wrap; font-size: 14px;"></p>
        <button class="btn retry-btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
      </div>
    </div>
  </div>

  <script>
    let doctors = [];
    let selectedDoctor = null;
    let selectedCourse = null;
    let selectedDate = null;
    let currentMonth = new Date();
const apiUrl =	"https://script.google.com/macros/s/AKfycbw8HzCZCGtJTmXnJ6f0l3UUbqlEQulM11949WLf7QfhZN-d8QTrPAkL7-eOxuU_cNW0/exec";
    
    // åˆå§‹åŒ–
    window.onload = function() {
     renderDoctorList();
    };
    
    async function renderDoctorList() {
	const response = await fetch(`${apiUrl}?action=getDoctors`);
        const doctors = await response.json();
      const list = document.getElementById('doctorList');
      list.innerHTML = '';
      if(doctors.length === 0) {
        list.innerHTML = '<div style="grid-column:1/-1;text-align:center;">ç„¡é†«å¸«è³‡æ–™</div>';
        return;
      }
      doctors.forEach(doctor => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = doctor.name;
        // ä½¿ç”¨ onclick ç¢ºä¿æ‰‹æ©Ÿç›¸å®¹æ€§
        btn.onclick = function() { selectDoctor(doctor); };
        list.appendChild(btn);
      });
    }
    
    function selectDoctor(doctor) {
      selectedDoctor = doctor;
      renderCourseList();
      goToStep(2);
    }
    
    function renderCourseList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      
      const courses = [];
      if (selectedDoctor.course1) courses.push(selectedDoctor.course1);
      if (selectedDoctor.course2) courses.push(selectedDoctor.course2);
      
      if(courses.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px;">æ­¤é†«å¸«æš«ç„¡èª²ç¨‹</div>';
      }

      courses.forEach(course => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = course;
        btn.onclick = function() { selectCourse(course); };
        list.appendChild(btn);
      });
    }
    
    function selectCourse(course) {
      selectedCourse = course;
      renderCalendar();
      goToStep(3);
    }
    
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      document.getElementById('currentMonth').textContent = `${year}å¹´ ${month + 1}æœˆ`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const container = document.getElementById('calendarDays');
      container.innerHTML = '';
      
      for (let i = 0; i < firstDay; i++) {
        container.appendChild(document.createElement('div'));
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;
        
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        
        if (date < today || dayOfWeek === 0 || dayOfWeek === 6) {
          dayElement.classList.add('disabled');
        } else {
          dayElement.onclick = function() { selectDate(date); };
        }
        container.appendChild(dayElement);
      }
    }
    
    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }
    
    function selectDate(date) {
      selectedDate = date;
      document.getElementById('selectedDateDisplay').textContent = 
        `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      goToStep(4);
      loadTimeSlots();
    }
    
    // === é—œéµä¿®æ­£ï¼šæ™‚æ®µè¼‰å…¥èˆ‡é»æ“Š ===
    async function loadTimeSlots() {
      const container = document.getElementById('timeSlots');
      container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">è¼‰å…¥æ™‚æ®µä¸­...</div>';
      
    try {
    // 2. ä½¿ç”¨ fetch å–ä»£ google.script.run
    const response = await fetch(`${apiUrl}?action=getAvailableSlots&date=${selectedDate.toISOString()}`);
    const slots = await response.json();

    // --- ä»¥ä¸‹é‚è¼¯èˆ‡ä½ åŸæœ¬çš„åŸºæœ¬ç›¸åŒ ---
    container.innerHTML = '';
    if (!slots || slots.length === 0) {
      container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #999;">æœ¬æ—¥å·²ç„¡æ™‚æ®µ</div>';
      return;
    }

    slots.forEach(function(slot) {
      const btn = document.createElement('button');
      btn.className = 'time-slot';
      btn.textContent = slot.display;
      btn.type = 'button';

      btn.onclick = function() {
        this.style.backgroundColor = '#667eea';
        this.style.color = 'white';
        this.textContent = 'é ç´„ä¸­...';
        this.disabled = true;

        // å‘¼å«é ç´„å‡½å¼ (ä¸‹æ–¹æœƒèªªæ˜å¦‚ä½•èª¿æ•´)
        confirmBooking(slot.start, slot.end);
      };
      container.appendChild(btn);
    });
    // ----------------------------

  } catch (error) {
    showError('è¼‰å…¥æ™‚æ®µå¤±æ•—: ' + error);
  }
    }
    
    async function confirmBooking(start, end) {
      goToStep(5); // Loading
      try {
    const response = await fetch(apiUrl, {
      method: 'POST',	 
      body: JSON.stringify({
        action: 'bookCourse',
        doctorName: selectedDoctor.name,
        courseName: selectedCourse,
        startTime: start,
        endTime: end
      })
    });
    const result = await response.json();
    if (result.success) alert('é ç´„æˆåŠŸï¼');
  } catch (error) {
    alert('é ç´„å¤±æ•—ï¼š' + error);
  }
     
    }
    
    function showError(msg) {
      document.getElementById('errorDetail').textContent = msg;
      goToStep(7); // Error section
    }
    
    function goToStep(step) {
      // éš±è—æ‰€æœ‰ section
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      
      // é¡¯ç¤ºç›®æ¨™ section (é™£åˆ—å°æ‡‰: doctor, course, date, time, loading, success, error)
      const sections = ['doctor', 'course', 'date', 'time', 'loading', 'success', 'error'];
      const targetId = 'section-' + sections[step - 1];
      const targetEl = document.getElementById(targetId);
      
      if (targetEl) {
        targetEl.classList.add('active');
        window.scrollTo(0, 0);
      }
      
      // æ›´æ–°ä¸Šæ–¹æ­¥é©Ÿçƒ (åªé¡¯ç¤ºå‰4æ­¥)
      if (step <= 4) {
        for (let i = 1; i <= step; i++) {
          document.getElementById('step' + i).classList.add('active');
        }
      }
    }
  </script>
</body>
</html>
